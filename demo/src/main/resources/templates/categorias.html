<div th:fragment="contenido">
  <h1 class="mb-4">Gestión de Categorías</h1>
  <form id="categoriaForm">
    <input type="hidden" id="idCategoria" />
    <div class="mb-3">
      <label for="nombre" class="form-label">Nombre:</label>
      <input type="text" id="nombre" class="form-control" required />
    </div>
    <button type="submit" class="btn btn-primary">Guardar</button>
    <button
      type="button"
      id="cancelarEdicion"
      class="btn btn-secondary"
      style="display: none"
    >
      Cancelar Edición
    </button>
  </form>

  <h2 class="mt-5">Listado de Categorías</h2>
  <table id="categoriasTable" class="table table-striped table-bordered mt-3">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    (() => {
      const categoriaForm = document.getElementById('categoriaForm');
      const idCategoriaInput = document.getElementById('idCategoria');
      const nombreInput = document.getElementById('nombre');
      const categoriasTableBody = document.querySelector(
        '#categoriasTable tbody'
      );
      const cancelarEdicionBtn = document.getElementById('cancelarEdicion');

      const API_URL = '/categoria';

      // Cargar categorías
      async function cargarCategorias() {
        try {
          const response = await fetch(API_URL);
          const categorias = await response.json();
          if (!categoriasTableBody) return;
          categoriasTableBody.innerHTML = '';
          categorias.forEach((categoria) => {
            const row = categoriasTableBody.insertRow();
            row.insertCell(0).textContent = categoria.idCategoria;
            row.insertCell(1).textContent = categoria.nombre;
            const accionesCell = row.insertCell(2);

            const editarBtn = document.createElement('button');
            editarBtn.textContent = 'Editar';
            editarBtn.className = 'btn btn-warning btn-sm me-2';
            editarBtn.addEventListener('click', () =>
              editarCategoria(categoria)
            );
            accionesCell.appendChild(editarBtn);

            const eliminarBtn = document.createElement('button');
            eliminarBtn.textContent = 'Eliminar';
            eliminarBtn.className = 'btn btn-danger btn-sm';
            eliminarBtn.addEventListener('click', () =>
              eliminarCategoria(categoria.idCategoria)
            );
            accionesCell.appendChild(eliminarBtn);
          });
        } catch (error) {
          console.error('Error al cargar categorías:', error);
        }
      }

      // Guardar/Actualizar categoría
      if (categoriaForm) {
        categoriaForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const categoria = { nombre: nombreInput.value };
          const id = idCategoriaInput.value;
          const method = id ? 'PUT' : 'POST';
          const url = id ? `${API_URL}/${id}` : API_URL;

          await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(categoria),
          });

          categoriaForm.reset();
          idCategoriaInput.value = '';
          cancelarEdicionBtn.style.display = 'none';
          cargarCategorias();
        });
      }

      // Editar categoría (carga los datos en el formulario)
      function editarCategoria(categoria) {
        idCategoriaInput.value = categoria.idCategoria;
        nombreInput.value = categoria.nombre;
        cancelarEdicionBtn.style.display = 'inline-block';
      }

      // Cancelar edición
      if (cancelarEdicionBtn) {
        cancelarEdicionBtn.addEventListener('click', () => {
          categoriaForm.reset();
          idCategoriaInput.value = '';
          cancelarEdicionBtn.style.display = 'none';
        });
      }

      // Eliminar categoría
      async function eliminarCategoria(id) {
        if (confirm('¿Estás seguro de que quieres eliminar esta categoría?')) {
          await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
          cargarCategorias();
        }
      }
      // Carga inicial
      cargarCategorias();
    })();
  </script>
</div>
